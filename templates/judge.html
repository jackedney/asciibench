{% extends "base.html" %}

{% block content %}
<header class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-10 rounded-xl shadow-lg mb-8">
    <h1 class="text-3xl font-bold text-white tracking-tight mb-2">ASCIIBench Judge Interface</h1>
    <p id="prompt-display"
       hx-get="/htmx/prompt"
       hx-trigger="load, matchup-loaded from:body"
       hx-swap="innerHTML"
       class="text-white/80 text-lg">
        Loading prompt...
    </p>
</header>

<div id="loading-indicator" class="loading-indicator htmx-indicator">
    Loading matchup...
</div>

<div id="matchup-container"
     hx-get="/htmx/matchup"
     hx-trigger="load"
     hx-swap="innerHTML"
     hx-indicator="#loading-indicator">
    {# Initial content will be replaced by HTMX #}
    <div class="comparison-container grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="sample bg-white border border-slate-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
            <h2 class="text-xl font-semibold text-slate-800 mb-4">Sample A</h2>
            <div class="font-variants">
                <div class="font-variant">
                    <span class="font-label bg-slate-100 text-slate-600 px-3 py-1.5 text-sm font-medium rounded-t-lg block mb-0">Classic</span>
                    <div class="art-display bg-slate-50 p-4 rounded-b-lg min-h-32 overflow-x-auto font-mono text-sm leading-relaxed text-slate-700 font-classic">Loading...</div>
                </div>
            </div>
        </div>
        <div class="sample bg-white border border-slate-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow">
            <h2 class="text-xl font-semibold text-slate-800 mb-4">Sample B</h2>
            <div class="font-variants">
                <div class="font-variant">
                    <span class="font-label bg-slate-100 text-slate-600 px-3 py-1.5 text-sm font-medium rounded-t-lg block mb-0">Classic</span>
                    <div class="art-display bg-slate-50 p-4 rounded-b-lg min-h-32 overflow-x-auto font-mono text-sm leading-relaxed text-slate-700 font-classic">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="error-message" class="error-message" style="display: none;"></div>

<div class="controls">
    <h3>Which sample do you prefer?</h3>

    {# Vote form with HTMX - hidden form that gets submitted via JavaScript #}
    <form id="vote-form"
          hx-post="/htmx/vote"
          hx-target="#matchup-container"
          hx-swap="innerHTML"
          hx-indicator="#loading-indicator"
          hx-on::after-request="htmx.trigger(document.body, 'vote-submitted')">
        <input type="hidden" name="sample_a_id" id="form-sample-a-id" value="" />
        <input type="hidden" name="sample_b_id" id="form-sample-b-id" value="" />
        <input type="hidden" name="winner" id="form-winner" value="" />
    </form>

    <div class="vote-buttons">
        <button id="btn-a" class="vote-btn" data-winner="A">A wins</button>
        <button id="btn-b" class="vote-btn" data-winner="B">B wins</button>
        <button id="btn-tie" class="vote-btn" data-winner="tie">Tie</button>
        <button id="btn-fail" class="vote-btn" data-winner="fail">Both fail</button>
    </div>
    <div class="undo-container">
        <button id="btn-undo"
                class="undo-btn"
                hx-post="/htmx/undo"
                hx-target="#matchup-container"
                hx-swap="innerHTML"
                hx-indicator="#loading-indicator"
                hx-on::after-request="htmx.trigger(document.body, 'undo-completed')">
            Undo (Z)
        </button>
    </div>
    <p class="keyboard-hint">
        Keyboard shortcuts:
        <span class="keyboard-key">A</span> left wins
        <span class="keyboard-key">D</span> right wins
        <span class="keyboard-key">S</span> tie
        <span class="keyboard-key">F</span> fail
        <span class="keyboard-key">Z</span> undo
    </p>
</div>

<div id="progress-display"
     class="progress-display"
     hx-get="/htmx/progress"
     hx-trigger="load, vote-submitted from:body, undo-completed from:body"
     hx-swap="innerHTML">
    <span id="progress-text">Loading progress...</span>
</div>

<p><a href="/">Back to Home</a></p>

<script>
(function() {
    'use strict';

    // State
    let isProcessing = false;

    // DOM Elements
    const voteForm = document.getElementById('vote-form');
    const formSampleAId = document.getElementById('form-sample-a-id');
    const formSampleBId = document.getElementById('form-sample-b-id');
    const formWinner = document.getElementById('form-winner');
    const btnA = document.getElementById('btn-a');
    const btnB = document.getElementById('btn-b');
    const btnTie = document.getElementById('btn-tie');
    const btnFail = document.getElementById('btn-fail');
    const btnUndo = document.getElementById('btn-undo');

    // Key to winner mapping
    const keyToWinner = {
        'a': 'A',
        'A': 'A',
        'd': 'B',
        'D': 'B',
        's': 'tie',
        'S': 'tie',
        'f': 'fail',
        'F': 'fail'
    };

    // Key to button mapping
    const keyToButton = {
        'a': btnA,
        'A': btnA,
        'd': btnB,
        'D': btnB,
        's': btnTie,
        'S': btnTie,
        'f': btnFail,
        'F': btnFail,
        'z': btnUndo,
        'Z': btnUndo
    };

    /**
     * Highlight a button briefly
     */
    function highlightButton(button) {
        if (!button) return;
        button.classList.add('active');
        setTimeout(() => {
            button.classList.remove('active');
        }, 150);
    }

    /**
     * Update hidden form fields from current matchup
     */
    function updateFormFields() {
        const sampleAIdInput = document.getElementById('sample-a-id');
        const sampleBIdInput = document.getElementById('sample-b-id');

        if (sampleAIdInput && sampleBIdInput) {
            formSampleAId.value = sampleAIdInput.value;
            formSampleBId.value = sampleBIdInput.value;
            return true;
        }
        return false;
    }

    /**
     * Submit a vote via HTMX form
     */
    function submitVote(winner) {
        if (isProcessing) return;

        // Update form fields from current matchup
        if (!updateFormFields()) {
            // No sample IDs found - likely in error state
            // Request a new matchup instead of voting
            htmx.ajax('GET', '/htmx/matchup', {target: '#matchup-container', swap: 'innerHTML'});
            return;
        }

        // Set the winner
        formWinner.value = winner;

        // Trigger HTMX form submission
        htmx.trigger(voteForm, 'submit');
    }

    /**
     * Handle keydown events
     */
    function handleKeydown(event) {
        // Ignore if typing in an input field
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            return;
        }

        // Ignore if processing
        if (isProcessing) return;

        const key = event.key;

        // Handle Ctrl+Z for undo
        if ((event.ctrlKey || event.metaKey) && (key === 'z' || key === 'Z')) {
            event.preventDefault();
            highlightButton(btnUndo);
            htmx.trigger(btnUndo, 'click');
            return;
        }

        // Handle undo with just 'z' or 'Z'
        if (key === 'z' || key === 'Z') {
            highlightButton(btnUndo);
            htmx.trigger(btnUndo, 'click');
            return;
        }

        // Handle vote keys
        if (keyToWinner[key]) {
            highlightButton(keyToButton[key]);
            submitVote(keyToWinner[key]);
            return;
        }

        // Other keys do nothing (as per acceptance criteria)
    }

    /**
     * Handle button clicks
     */
    function handleButtonClick(event) {
        const winner = event.target.dataset.winner;
        if (winner) {
            highlightButton(event.target);
            submitVote(winner);
        }
    }

    // Set processing state during HTMX requests
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        isProcessing = true;
        // Disable buttons
        btnA.disabled = true;
        btnB.disabled = true;
        btnTie.disabled = true;
        btnFail.disabled = true;
        btnUndo.disabled = true;
    });

    document.body.addEventListener('htmx:afterRequest', function(event) {
        isProcessing = false;
        // Re-enable buttons
        btnA.disabled = false;
        btnB.disabled = false;
        btnTie.disabled = false;
        btnFail.disabled = false;
        btnUndo.disabled = false;
    });

    // Trigger prompt update when matchup loads
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.target.id === 'matchup-container') {
            htmx.trigger(document.body, 'matchup-loaded');
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Add keyboard event listener
        document.addEventListener('keydown', handleKeydown);

        // Add click handlers to vote buttons
        btnA.addEventListener('click', handleButtonClick);
        btnB.addEventListener('click', handleButtonClick);
        btnTie.addEventListener('click', handleButtonClick);
        btnFail.addEventListener('click', handleButtonClick);
        // Note: btnUndo uses HTMX directly via hx-post attribute
    });
})();
</script>
{% endblock %}
