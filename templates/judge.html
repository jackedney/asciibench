{% extends "base.html" %}

{% block content %}
<style>
@keyframes rainbow-cycle {
    0% { color: #FF0000; }
    8% { color: #FF7F00; }
    16% { color: #FFFF00; }
    25% { color: #00FF00; }
    33% { color: #00FFFF; }
    41% { color: #0000FF; }
    50% { color: #4000FF; }
    58% { color: #8000FF; }
    66% { color: #FF00FF; }
    75% { color: #FF00BF; }
    83% { color: #FF007F; }
    91% { color: #9400D3; }
    100% { color: #FF0000; }
}

.rainbow-text {
    animation: rainbow-cycle 3s linear infinite;
    text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
}

.brutalist-shadow {
    box-shadow: 4px 4px 0 0 #e2e8f0;
}

.brutalist-shadow-sm {
    box-shadow: 2px 2px 0 0 #e2e8f0;
}

.font-toggle {
    cursor: pointer;
    user-select: none;
}

.font-toggle:hover {
    color: #38bdf8;
}

.art-display {
    transition: font-family 0.15s ease;
}

/* Tab styles */
.tab-btn {
    cursor: pointer;
    transition: all 0.15s ease;
}

.tab-btn:hover {
    color: #38bdf8;
}

.tab-btn.active {
    color: #38bdf8;
    border-color: #38bdf8;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}
</style>

<header class="mb-6 overflow-hidden">
    <pre class="ascii-banner text-xs sm:text-sm leading-none text-center mb-4 overflow-x-auto" aria-hidden="true"><span class="rainbow-text"> █████╗ ███████╗ ██████╗██╗██╗██████╗ ███████╗███╗   ██╗ ██████╗██╗  ██╗
██╔══██╗██╔════╝██╔════╝██║██║██╔══██╗██╔════╝████╗  ██║██╔════╝██║  ██║
███████║███████╗██║     ██║██║██████╔╝█████╗  ██╔██╗ ██║██║     ███████║
██╔══██║╚════██║██║     ██║██║██╔══██╗██╔══╝  ██║╚██╗██║██║     ██╔══██║
██║  ██║███████║╚██████╗██║██║██████╔╝███████╗██║ ╚████║╚██████╗██║  ██║
╚═╝  ╚═╝╚══════╝ ╚═════╝╚═╝╚═╝╚═════╝ ╚══════╝╚═╝  ╚═══╝ ╚═════╝╚═╝  ╚═╝</span></pre>
</header>

<!-- Tab Navigation -->
<nav class="tab-navigation flex justify-center gap-4 mb-8" role="tablist">
    <button id="tab-judge" class="tab-btn px-6 py-2 text-base border-2 border-slate-500 bg-slate-800 text-slate-200 brutalist-shadow-sm active" data-tab="judge" role="tab" aria-selected="true" aria-controls="judge-content">
        [J] JUDGE
    </button>
    <button id="tab-analytics" class="tab-btn px-6 py-2 text-base border-2 border-slate-500 bg-slate-800 text-slate-200 brutalist-shadow-sm" data-tab="analytics" role="tab" aria-selected="false" aria-controls="analytics-content">
        [L] ANALYTICS
    </button>
</nav>

<!-- Judge Tab Content -->
<div id="judge-content" class="tab-content active">
    <div class="text-center mb-6">
        <span class="text-slate-500 mr-4">FONT:</span>
        <label class="font-toggle mr-4" id="font-classic-label">
            <span class="font-bracket">[</span><span id="font-classic-check">X</span><span class="font-bracket">]</span> Classic
        </label>
        <label class="font-toggle mr-4" id="font-modern-label">
            <span class="font-bracket">[</span><span id="font-modern-check"> </span><span class="font-bracket">]</span> Modern
        </label>
        <label class="font-toggle" id="font-condensed-label">
            <span class="font-bracket">[</span><span id="font-condensed-check"> </span><span class="font-bracket">]</span> Condensed
        </label>
    </div>

    <p id="prompt-display"
       class="text-slate-300 text-lg text-center border border-slate-700 p-3 mb-8">
        Loading prompt...
    </p>

    <div id="loading-indicator" class="loading-indicator htmx-indicator text-center py-8 text-slate-500 text-base">
        Loading matchup...
    </div>

    <div id="matchup-container"
         hx-get="/htmx/matchup"
         hx-trigger="load"
         hx-swap="innerHTML"
         hx-indicator="#loading-indicator">
        {# Initial content will be replaced by HTMX #}
        <div class="comparison-container grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="sample border-2 border-slate-600 p-4 brutalist-shadow">
                <h2 class="text-lg text-slate-400 mb-3 border-b border-slate-700 pb-2">// SAMPLE A</h2>
                <pre class="art-display bg-slate-950 p-4 min-h-32 overflow-x-auto text-sm leading-none text-slate-200 font-classic border border-slate-700">Loading...</pre>
            </div>
            <div class="sample border-2 border-slate-600 p-4 brutalist-shadow">
                <h2 class="text-lg text-slate-400 mb-3 border-b border-slate-700 pb-2">// SAMPLE B</h2>
                <pre class="art-display bg-slate-950 p-4 min-h-32 overflow-x-auto text-sm leading-none text-slate-200 font-classic border border-slate-700">Loading...</pre>
            </div>
        </div>
    </div>

    <div id="error-message" class="error-message bg-red-950 border-2 border-red-500 text-red-400 p-4 text-center mb-4" style="display: none;"></div>

    <div class="controls text-center mt-8">
        <p class="text-slate-500 mb-4">// WHICH SAMPLE DO YOU PREFER?</p>

        {# Vote form with HTMX - hidden form that gets submitted via JavaScript #}
        <form id="vote-form"
              hx-post="/htmx/vote"
              hx-target="#matchup-container"
              hx-swap="innerHTML"
              hx-indicator="#loading-indicator"
              hx-on::after-request="htmx.trigger(document.body, 'vote-submitted')">
            <input type="hidden" name="sample_a_id" id="form-sample-a-id" value="" />
            <input type="hidden" name="sample_b_id" id="form-sample-b-id" value="" />
            <input type="hidden" name="matchup_id" id="form-matchup-id" value="" />
            <input type="hidden" name="winner" id="form-winner" value="" />
        </form>

        <div class="vote-buttons flex justify-center gap-3 mb-4">
            <button id="btn-a" class="vote-btn px-6 py-3 text-base border-2 border-slate-500 bg-slate-800 text-slate-200 hover:bg-slate-700 hover:border-slate-400 brutalist-shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed" data-winner="A">[A] LEFT</button>
            <button id="btn-b" class="vote-btn px-6 py-3 text-base border-2 border-slate-500 bg-slate-800 text-slate-200 hover:bg-slate-700 hover:border-slate-400 brutalist-shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed" data-winner="B">[D] RIGHT</button>
            <button id="btn-tie" class="vote-btn px-6 py-3 text-base border-2 border-slate-500 bg-slate-800 text-slate-200 hover:bg-slate-700 hover:border-slate-400 brutalist-shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed" data-winner="tie">[S] TIE</button>
            <button id="btn-fail" class="vote-btn px-6 py-3 text-base border-2 border-slate-500 bg-slate-800 text-slate-200 hover:bg-slate-700 hover:border-slate-400 brutalist-shadow-sm transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed" data-winner="fail">[F] FAIL</button>
        </div>
        <div class="undo-container">
            <button id="btn-undo"
                    class="undo-btn px-6 py-2 text-sm border border-slate-600 bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-300 transition-colors"
                    hx-post="/htmx/undo"
                    hx-target="#matchup-container"
                    hx-swap="innerHTML"
                    hx-indicator="#loading-indicator"
                    hx-on::after-request="htmx.trigger(document.body, 'undo-completed')">
                [Z] UNDO
            </button>
        </div>
    </div>

    <div id="progress-display"
         class="progress-display text-center mt-6 p-3 border border-slate-700 text-sm text-slate-500"
         hx-get="/htmx/progress"
         hx-trigger="load, vote-submitted from:body, undo-completed from:body"
         hx-swap="innerHTML">
        <span id="progress-text">Loading progress...</span>
    </div>
</div>

<!-- Analytics Tab Content -->
<div id="analytics-content" class="tab-content">
    <div id="analytics-loading" class="text-center py-8 text-slate-500 text-base">
        Loading analytics...
    </div>
    <div id="analytics-container">
        {# Will be populated by HTMX when tab is activated #}
    </div>
</div>

<p class="mt-6"><a href="/" class="text-slate-500 hover:text-slate-300 border-b border-slate-600 hover:border-slate-400">&lt;- Back to Home</a></p>

<script>
(() => {
    'use strict';

    // State
    let isProcessing = false;
    let currentFont = 'classic';
    let currentTab = 'judge';

    // Tab elements
    const tabJudge = document.getElementById('tab-judge');
    const tabAnalytics = document.getElementById('tab-analytics');
    const judgeContent = document.getElementById('judge-content');
    const analyticsContent = document.getElementById('analytics-content');
    const analyticsContainer = document.getElementById('analytics-container');
    const analyticsLoading = document.getElementById('analytics-loading');

    /**
     * Switch between tabs
     */
    function switchTab(tabName) {
        currentTab = tabName;

        // Update tab button styles and ARIA states
        tabJudge.classList.toggle('active', tabName === 'judge');
        tabAnalytics.classList.toggle('active', tabName === 'analytics');
        tabJudge.setAttribute('aria-selected', tabName === 'judge' ? 'true' : 'false');
        tabAnalytics.setAttribute('aria-selected', tabName === 'analytics' ? 'true' : 'false');

        // Show/hide tab content
        judgeContent.classList.toggle('active', tabName === 'judge');
        analyticsContent.classList.toggle('active', tabName === 'analytics');

        // Load analytics data when switching to analytics tab
        if (tabName === 'analytics') {
            loadAnalytics();
        }
    }

    /**
     * Load analytics data via HTMX
     */
    function loadAnalytics() {
        // Always reload when switching to analytics tab
        analyticsLoading.style.display = 'block';
        analyticsContainer.innerHTML = '';

        htmx.ajax('GET', '/htmx/analytics', {
            target: '#analytics-container',
            swap: 'innerHTML'
        }).then(() => {
            analyticsLoading.style.display = 'none';
        }).catch((error) => {
            analyticsLoading.style.display = 'none';
            analyticsContainer.innerHTML = '<p class="text-red-400 text-center py-4">Failed to load analytics. Please try again.</p>';
            console.error('Analytics loading error:', error);
        });
    }

    // Tab click handlers
    tabJudge.addEventListener('click', () => switchTab('judge'));
    tabAnalytics.addEventListener('click', () => switchTab('analytics'));

    // Font toggle elements
    const fontLabels = {
        classic: document.getElementById('font-classic-label'),
        modern: document.getElementById('font-modern-label'),
        condensed: document.getElementById('font-condensed-label')
    };
    const fontChecks = {
        classic: document.getElementById('font-classic-check'),
        modern: document.getElementById('font-modern-check'),
        condensed: document.getElementById('font-condensed-check')
    };

    /**
     * Switch the active font for all art displays
     */
    function setFont(fontName) {
        currentFont = fontName;

        // Update toggle display
        Object.keys(fontChecks).forEach(key => {
            fontChecks[key].textContent = key === fontName ? 'X' : ' ';
        });

        // Update all art displays
        document.querySelectorAll('.art-display').forEach(el => {
            el.classList.remove('font-classic', 'font-modern', 'font-condensed');
            el.classList.add('font-' + fontName);
        });

        // Save preference
        localStorage.setItem('asciibench-font', fontName);
    }

    // Initialize font toggles
    Object.keys(fontLabels).forEach(fontName => {
        fontLabels[fontName].addEventListener('click', () => setFont(fontName));
    });

    // Load saved font preference
    const savedFont = localStorage.getItem('asciibench-font');
    if (savedFont && ['classic', 'modern', 'condensed'].includes(savedFont)) {
        setFont(savedFont);
    }

    // DOM Elements for voting
    const voteForm = document.getElementById('vote-form');
    const formSampleAId = document.getElementById('form-sample-a-id');
    const formSampleBId = document.getElementById('form-sample-b-id');
    const formWinner = document.getElementById('form-winner');
    const btnA = document.getElementById('btn-a');
    const btnB = document.getElementById('btn-b');
    const btnTie = document.getElementById('btn-tie');
    const btnFail = document.getElementById('btn-fail');
    const btnUndo = document.getElementById('btn-undo');

    // Key to winner mapping
    const keyToWinner = {
        'a': 'A',
        'A': 'A',
        'd': 'B',
        'D': 'B',
        's': 'tie',
        'S': 'tie',
        'f': 'fail',
        'F': 'fail'
    };

    // Key to button mapping
    const keyToButton = {
        'a': btnA,
        'A': btnA,
        'd': btnB,
        'D': btnB,
        's': btnTie,
        'S': btnTie,
        'f': btnFail,
        'F': btnFail,
        'z': btnUndo,
        'Z': btnUndo
    };

    /**
     * Highlight a button briefly
     */
    function highlightButton(button) {
        if (!button) return;
        button.classList.add('active');
        setTimeout(() => {
            button.classList.remove('active');
        }, 150);
    }

    /**
     * Update hidden form fields from current matchup
     */
    function updateFormFields() {
        const sampleAIdInput = document.getElementById('sample-a-id');
        const sampleBIdInput = document.getElementById('sample-b-id');
        const matchupIdInput = document.getElementById('matchup-id');

        if (sampleAIdInput && sampleBIdInput) {
            formSampleAId.value = sampleAIdInput.value;
            formSampleBId.value = sampleBIdInput.value;
            const formMatchupId = document.getElementById('form-matchup-id');
            if (formMatchupId && matchupIdInput) {
                formMatchupId.value = matchupIdInput.value;
            }
            return true;
        }
        return false;
    }

    /**
     * Check if the UI is showing the vote reveal panel
     */
    function isInRevealState() {
        return !!document.querySelector('[data-reveal-state="true"]');
    }

    /**
     * Submit a vote via HTMX form
     */
    function submitVote(winner) {
        if (isProcessing) return;

        // Don't accept votes during reveal state
        if (isInRevealState()) return;

        // Update form fields from current matchup
        if (!updateFormFields()) {
            // No sample IDs found - likely in error state
            // Request a new matchup instead of voting
            htmx.ajax('GET', '/htmx/matchup', {target: '#matchup-container', swap: 'innerHTML'});
            return;
        }

        // Set the winner
        formWinner.value = winner;

        // Trigger HTMX form submission
        htmx.trigger(voteForm, 'submit');
    }

    /**
     * Handle keydown events
     */
    function handleKeydown(event) {
        // Ignore if typing in an input field
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            return;
        }

        const key = event.key;

        // Tab switching with J and L keys
        if (key === 'j' || key === 'J') {
            switchTab('judge');
            return;
        }
        if (key === 'l' || key === 'L') {
            switchTab('analytics');
            return;
        }

        // Only handle vote keys if on judge tab
        if (currentTab !== 'judge') {
            return;
        }

        // Ignore if processing
        if (isProcessing) return;

        // Handle Ctrl+Z for undo (blocked during reveal)
        if ((event.ctrlKey || event.metaKey) && (key === 'z' || key === 'Z')) {
            event.preventDefault();
            if (!isInRevealState()) {
                highlightButton(btnUndo);
                htmx.trigger(btnUndo, 'click');
            }
            return;
        }

        // Handle undo with just 'z' or 'Z' (blocked during reveal)
        if (key === 'z' || key === 'Z') {
            if (!isInRevealState()) {
                highlightButton(btnUndo);
                htmx.trigger(btnUndo, 'click');
            }
            return;
        }

        // Handle vote keys
        if (keyToWinner[key]) {
            highlightButton(keyToButton[key]);
            submitVote(keyToWinner[key]);
            return;
        }

        // Other keys do nothing (as per acceptance criteria)
    }

    /**
     * Handle button clicks
     */
    function handleButtonClick(event) {
        const winner = event.target.dataset.winner;
        if (winner) {
            highlightButton(event.target);
            submitVote(winner);
        }
    }

    // Set processing state during HTMX requests
    document.body.addEventListener('htmx:beforeRequest', (event) => {
        // Only set processing state for judge-related requests
        if (event.target.closest('#judge-content')) {
            isProcessing = true;
            // Disable buttons
            btnA.disabled = true;
            btnB.disabled = true;
            btnTie.disabled = true;
            btnFail.disabled = true;
            btnUndo.disabled = true;
        }
    });

    document.body.addEventListener('htmx:afterRequest', (event) => {
        // Only update processing state for judge-related requests
        if (event.target.closest('#judge-content')) {
            isProcessing = false;
            // Re-enable buttons
            btnA.disabled = false;
            btnB.disabled = false;
            btnTie.disabled = false;
            btnFail.disabled = false;
            btnUndo.disabled = false;
        }
    });

    // Trigger prompt update when matchup loads and apply current font
    document.body.addEventListener('htmx:afterSwap', (event) => {
        if (event.target.id === 'matchup-container') {
            htmx.trigger(document.body, 'matchup-loaded');
            // Re-apply current font to newly loaded art displays
            setFont(currentFont);
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Add keyboard event listener
        document.addEventListener('keydown', handleKeydown);

        // Add click handlers to vote buttons
        btnA.addEventListener('click', handleButtonClick);
        btnB.addEventListener('click', handleButtonClick);
        btnTie.addEventListener('click', handleButtonClick);
        btnFail.addEventListener('click', handleButtonClick);
        // Note: btnUndo uses HTMX directly via hx-post attribute
    });
})();
</script>
{% endblock %}
